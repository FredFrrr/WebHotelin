<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOTELIN - Booking System</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- CSS DESIGN --- */
        :root { 
            --primary: #2563eb; 
            --dark-blue: #1e40af;
            --accent: #f59e0b; 
            --light: #f3f4f6; 
            --dark: #1f2937; 
            --success: #10b981; 
            --wa-color: #25D366; 
            --danger: #ef4444; 
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Lato', sans-serif; background-color: var(--light); color: var(--dark); padding-bottom: 50px; }

        /* NAVBAR */
        .navbar { 
            padding: 1.2rem 5%; background: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100;
        }
        .logo { font-family: 'Montserrat', sans-serif; font-size: 1.8rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; }

        /* HERO SECTION */
        .hero { 
            height: 55vh; 
            background: linear-gradient(rgba(37, 99, 235, 0.8), rgba(30, 64, 175, 0.8)), url('https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80'); 
            background-size: cover; background-position: center; 
            display: flex; align-items: center; justify-content: center; 
            color: white; text-align: center; 
        }
        .hero h1 { font-family: 'Montserrat', sans-serif; font-size: 2.5rem; margin-bottom: 10px; }

        /* BOOKING WIDGET */
        .booking-widget { 
            background: white; padding: 2rem; border-radius: 12px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
            display: flex; gap: 15px; width: 90%; max-width: 900px; 
            position: relative; bottom: -40px; margin: 0 auto; flex-wrap: wrap; 
        }
        .form-group { flex: 1; min-width: 150px; }
        .form-group label { display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; color: #6b7280; text-transform: uppercase; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: bold; }
        .search-btn { background: var(--primary); color: white; border: none; padding: 0 30px; font-weight: bold; cursor: pointer; border-radius: 8px; flex-grow: 1; transition:0.3s;}
        .search-btn:hover { background: var(--dark-blue); }

        /* RESULTS GRID */
        .container { max-width: 1100px; margin: 100px auto 50px; padding: 0 20px; }
        .room-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 30px; }
        .room-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; transition: transform 0.3s; }
        .room-card:hover { transform: translateY(-5px); }
        .room-img { height: 200px; background-size: cover; background-position: center; }
        .room-details { padding: 20px; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; color: white; display: inline-block; font-weight: bold; }
        .bg-ok { background: var(--success); } .bg-low { background: var(--accent); } .bg-empty { background: var(--danger); }
        .btn-book { width: 100%; padding: 12px; background: var(--dark); color: white; border: none; cursor: pointer; border-radius: 8px; margin-top: 15px; font-weight: bold; }
        .btn-book:disabled { background: #d1d5db; cursor: not-allowed; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #9ca3af; }
        
        /* INVOICE DESIGN */
        #invoice-area { padding: 30px; border: 2px solid #e5e7eb; margin-bottom: 20px; background: #fff; color: #333; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        .inv-header { text-align: center; border-bottom: 2px solid var(--primary); padding-bottom: 20px; margin-bottom: 20px; }
        .inv-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; border-bottom: 1px dashed #f3f4f6; padding-bottom: 5px; }
        
        /* BUTTON GROUPS */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-wa { background-color: var(--wa-color); color: white; flex: 1; }
        .btn-pdf { background-color: var(--danger); color: white; flex: 1; }
        
        /* LOADING */
        .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 10; border-radius: 16px; }
        .spinner { font-size: 3rem; animation: spin 1.5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav class="navbar"><div class="logo">HOTELIN<span>.</span></div></nav>
    <header class="hero"><div><h1>Stay Comfortable.</h1><p>Booking Hotel Terbaik dengan Harga Hemat</p></div></header>

    <div class="booking-widget">
        <div class="form-group"><label>Tanggal Check-in</label><input type="date" id="checkInDate"></div>
        <div class="form-group"><label>Durasi (Malam)</label><input type="number" id="duration" value="1" min="1"></div>
        <button class="search-btn" onclick="app.searchRooms()">Cari Kamar</button>
    </div>

    <div class="container" id="results-section" style="display: none;">
        <h2 style="margin-bottom: 20px; font-family:'Montserrat', sans-serif;">Pilih Kamar</h2>
        <p style="margin-bottom: 30px; color: #666;">Tanggal: <b id="res-date"></b> (<span id="res-dur"></span> Malam)</p>
        <div class="room-grid" id="rooms-grid"></div>
    </div>

    <div class="modal" id="bookingModal">
        <div class="modal-content">
            <span class="close-btn" onclick="app.closeModal('bookingModal')">&times;</span>
            <h2 style="font-family:'Montserrat',sans-serif;">Data Pemesan</h2>
            <p style="color:#666; font-size:0.9rem;">Kamar: <strong id="modal-room-type" style="color:var(--primary)"></strong></p>
            <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">
            
            <div class="form-group"><label>Nama Lengkap</label><input type="text" id="guestName" placeholder="Nama sesuai KTP"></div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label>Email</label>
                <input type="email" id="guestEmail" placeholder="email@contoh.com">
                <small style="color: #666; font-size: 0.7rem;">Struk otomatis dikirim ke sini.</small>
            </div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label>Nomor WhatsApp</label>
                <input type="number" id="guestWA" placeholder="Contoh: 08123456789">
                <small style="color: #666; font-size: 0.7rem;">Untuk mengirim struk gambar.</small>
            </div>
            
            <button class="btn-book" style="background:var(--primary)" onclick="app.processBooking()">Bayar & Konfirmasi</button>
            
            <div class="loading-overlay" id="loadingState">
                <div class="spinner">üöÄ</div>
                <p style="margin-top: 15px; font-weight: bold;">Memproses & Mengirim Email...</p>
            </div>
        </div>
    </div>

    <div class="modal" id="invoiceModal">
        <div class="modal-content">
            <span class="close-btn" onclick="app.closeModal('invoiceModal')">&times;</span>
            <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 3rem;">üéâ</div>
                <h3 style="color: var(--success);">Pembayaran Berhasil!</h3>
                <p style="font-size:0.8rem; color:#666;">Email konfirmasi telah dikirim.</p>
            </div>
            
            <div id="invoice-area">
                <div class="inv-header">
                    <div style="font-size: 1.8rem; font-weight: 800; color: var(--primary);">HOTELIN.</div>
                    <div style="font-size: 0.8rem; color: #666;">Bukti Reservasi Resmi</div>
                </div>
                <div class="inv-row"><span>Kode Booking</span><strong id="inv-code"></strong></div>
                <div class="inv-row"><span>Nama Tamu</span><strong id="inv-name"></strong></div>
                <div class="inv-row"><span>Tipe Kamar</span><span id="inv-room"></span></div>
                <div class="inv-row"><span>No. Pintu</span><strong id="inv-room-no" style="background:var(--primary); color:#fff; padding:2px 6px; border-radius:4px;"></strong></div>
                <div class="inv-row"><span>Check-in</span><span id="inv-date"></span></div>
                <div class="inv-row"><span>Check-out</span><span id="inv-out"></span></div>
                <div class="inv-row" style="border-top:2px solid #ddd; padding-top:10px; margin-top:10px; font-weight:bold; color:var(--primary);">
                    <span>TOTAL BAYAR</span><span id="inv-price"></span>
                </div>
            </div>
            
            <p style="text-align: center; font-size: 0.8rem; color: #666; margin-top: 15px;">Pilih metode simpan:</p>
            
            <div class="btn-group">
                <button class="btn-book btn-wa" id="btnWA" onclick="app.shareImageToWA()">
                    üñºÔ∏è Kirim Gambar ke WA
                </button>
                <button class="btn-book btn-pdf" onclick="app.downloadPDF()">
                    üìÑ Unduh PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIG EMAILJS (DATA ANDA)
        // ============================================
        const MY_PUBLIC_KEY = "UFHNBbqXZ67MStb9J";
        const MY_SERVICE_ID = "service_n8duf2r";
        const MY_TEMPLATE_ID = "template_4zn8h8o";

        // Init EmailJS
        (function() { emailjs.init(MY_PUBLIC_KEY); })();

        // DATA KAMAR
        const dbRooms = [
            { id: "std", type: "Standard Room", totalStock: 10, price: 450000, img: "https://images.unsplash.com/photo-1631049307264-da0ec9d70304?auto=format&fit=crop&w=500&q=60" },
            { id: "dlx", type: "Deluxe Room", totalStock: 5, price: 750000, img: "https://images.unsplash.com/photo-1618773928121-c32242e63f39?auto=format&fit=crop&w=500&q=60" },
            { id: "exc", type: "Executive Suite", totalStock: 5, price: 1200000, img: "https://images.unsplash.com/photo-1578683010236-d716f9a3f461?auto=format&fit=crop&w=500&q=60" }
        ];
        let bookingsDB = [];

        const app = {
            state: { selectedRoomId: null, checkInDate: "", checkOutDate: "", duration: 1, totalPrice: 0, guestName: "", guestWA: "", guestEmail: "" },
            formatRupiah: (num) => new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR'}).format(num),

            getAvailableStock: (roomId, reqStart, reqEnd) => {
                const room = dbRooms.find(r => r.id === roomId);
                const clash = bookingsDB.filter(b => (b.roomId === roomId) && (b.start < reqEnd) && (b.end > reqStart));
                return room.totalStock - clash.length;
            },

            searchRooms: () => {
                const dateIn = document.getElementById('checkInDate').value;
                const dur = parseInt(document.getElementById('duration').value) || 1;
                if(!dateIn) return alert("Pilih tanggal Check-in!");

                const d = new Date(dateIn); d.setDate(d.getDate() + dur);
                const dateOut = d.toISOString().split('T')[0];

                app.state.checkInDate = dateIn; app.state.checkOutDate = dateOut; app.state.duration = dur;
                document.getElementById('results-section').style.display = 'block';
                document.getElementById('res-date').innerText = dateIn; document.getElementById('res-dur').innerText = dur;
                
                const grid = document.getElementById('rooms-grid'); grid.innerHTML = "";
                dbRooms.forEach(room => {
                    const sisa = app.getAvailableStock(room.id, app.state.checkInDate, app.state.checkOutDate);
                    let badge = sisa <= 0 ? 'bg-empty' : (sisa <= 2 ? 'bg-low' : 'bg-ok');
                    let disabled = sisa <= 0 ? 'disabled' : '';
                    let txt = sisa <= 0 ? 'HABIS' : 'PILIH';

                    grid.innerHTML += `
                        <div class="room-card">
                            <div class="room-img" style="background-image: url('${room.img}')"></div>
                            <div class="room-details">
                                <h3>${room.type}</h3>
                                <div class="price">${app.formatRupiah(room.price)} <small>/malam</small></div>
                                <span class="badge ${badge}">Sisa: ${sisa}</span>
                                <button class="btn-book" ${disabled} onclick="app.openModal('${room.id}')">${txt}</button>
                            </div>
                        </div>`;
                });
                document.getElementById('results-section').scrollIntoView({behavior:'smooth'});
            },

            openModal: (roomId) => {
                app.state.selectedRoomId = roomId;
                const room = dbRooms.find(r => r.id === roomId);
                app.state.totalPrice = room.price * app.state.duration;
                document.getElementById('modal-room-type').innerText = room.type;
                document.getElementById('bookingModal').style.display = 'flex';
                document.getElementById('loadingState').style.display = 'none';
            },
            closeModal: (id) => document.getElementById(id).style.display = 'none',

            // --- PROSES UTAMA (Email Otomatis, WA Manual via Tombol) ---
            processBooking: () => {
                const name = document.getElementById('guestName').value;
                const email = document.getElementById('guestEmail').value;
                const wa = document.getElementById('guestWA').value;

                if(!name || !email || !wa) return alert("Wajib isi Nama, Email, dan WA!");

                document.getElementById('loadingState').style.display = 'flex';

                const code = "HTL-" + Math.floor(100000 + Math.random() * 900000);
                let prefix = app.state.selectedRoomId === 'dlx' ? "2" : (app.state.selectedRoomId === 'exc' ? "3" : "1");
                const roomNo = prefix + "0" + Math.floor(Math.random() * 9 + 1);
                const room = dbRooms.find(r => r.id === app.state.selectedRoomId);

                bookingsDB.push({ id: code, roomId: app.state.selectedRoomId, start: app.state.checkInDate, end: app.state.checkOutDate, name: name });

                // Update State (PENTING AGAR TIDAK TERCAMPUR)
                app.state.guestName = name;
                app.state.guestEmail = email;
                app.state.guestWA = wa;
                app.state.bookingCode = code;

                // VARIABEL LOKAL (AMAN) - Data untuk Email
                const emailParams = { 
                    to_email: email, 
                    to_name: name, 
                    booking_code: code, 
                    room_type: room.type, 
                    room_number: roomNo, 
                    check_in: app.state.checkInDate, 
                    check_out: app.state.checkOutDate, 
                    duration: app.state.duration, 
                    total_price: app.formatRupiah(app.state.totalPrice) 
                };

                // Kirim Email (Background)
                emailjs.send(MY_SERVICE_ID, MY_TEMPLATE_ID, emailParams)
                    .then(() => {
                        console.log("Email sukses terkirim ke " + email);
                        app.finalizeBooking(code, name, room, roomNo);
                    }, (err) => {
                        console.error("Email gagal", err);
                        alert("Booking sukses, tapi email gagal terkirim.");
                        app.finalizeBooking(code, name, room, roomNo);
                    });
            },

            finalizeBooking: (code, name, room, roomNo) => {
                app.closeModal('bookingModal');
                app.searchRooms();
                
                // Render Struk
                document.getElementById('inv-code').innerText = code;
                document.getElementById('inv-name').innerText = name.toUpperCase();
                document.getElementById('inv-room').innerText = room.type;
                document.getElementById('inv-room-no').innerText = roomNo;
                document.getElementById('inv-date').innerText = app.state.checkInDate;
                document.getElementById('inv-out').innerText = app.state.checkOutDate;
                document.getElementById('inv-price').innerText = app.formatRupiah(app.state.totalPrice);
                
                // Tampilkan Modal Struk
                document.getElementById('invoiceModal').style.display = 'flex';
            },

            // --- FITUR WA GAMBAR (USER INTI) ---
            shareImageToWA: async () => {
                const btn = document.getElementById('btnWA');
                const oriText = btn.innerText;
                btn.innerText = "‚è≥ Memproses...";

                let phone = app.state.guestWA;
                if(phone.startsWith('0')) phone = '62' + phone.slice(1);

                try {
                    // 1. Potret
                    const canvas = await html2canvas(document.getElementById('invoice-area'));
                    const dataUrl = canvas.toDataURL("image/png");

                    // 2. Download
                    const link = document.createElement('a');
                    link.download = `Struk-${app.state.bookingCode}.png`;
                    link.href = dataUrl;
                    link.click();

                    // 3. Buka WA (Self Chat)
                    setTimeout(() => {
                        const msg = `Halo, ini arsip bukti booking HOTELIN saya.\nKode: ${app.state.bookingCode}\n\n(Lampirkan gambar yang baru terunduh di sini)`;
                        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
                        btn.innerText = oriText;
                    }, 1500);

                } catch (e) {
                    alert("Gagal memproses gambar.");
                    btn.innerText = oriText;
                }
            },

            downloadPDF: () => {
                const el = document.getElementById('invoice-area');
                html2pdf().from(el).save('Tiket-HOTELIN.pdf');
            }
        };

        document.getElementById('checkInDate').valueAsDate = new Date();
    </script>
</body>
</html>
